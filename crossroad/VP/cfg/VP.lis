    1          PROGR PLANT
    2          {
    3          TACT 50;
    4          CONST ON 1;
    5          CONST OFF 0;
    6          CONST DrivingTime 10; /*(60)~3 сек машина едет до датчика или от датчика после пересечения автострады*/
    7          CONST CrossingTime 10; /*(60)~3 сек для пересечения автострады*/
    8          CONST YellowLightTime 20; /*(160)~8 сек горит желтый свет светофора*/
    9          CONST SensorTime 10; /*(40)~2 сек машина проезжает датчик*/
   10          CONST Norm 1;
   11          CONST Wrong 0;
   12          
   13          ENUM
   14          {		
   15          	SCM2VP_RUN_CAR,
   16          	SCM2VP_RUN_WRONG_CAR,
   17          	SCM2VP_RUN_TWO_CARS
   18          };
   19          
   20          FUNCTION INT GetMessageFromScenariousBlock(VOID);
   21          FUNCTION INT GetMessageCodeFromScenariousBlock(VOID);
   22          	
   23          INPUT  LOG_VP_INPUT_PORT  0 0 8; 
   24          OUTPUT LOG_VP_OUTPUT_PORT 1 0 8;
   25          
   26          PROC Init
   27          {
   28          LOG I_SWITCH_TRAFFIC_LIGHT = {LOG_VP_INPUT_PORT[1]} FOR ALL;
   29          LOG S_CAR_NEAR_CROSSROAD = {LOG_VP_OUTPUT_PORT[1]} FOR ALL;
   30          	
   31          	STATE Start
   32          	{ 			
   33          		START PROC ReceiveSCMOutputMsg;
   34          		STOP;  
   35          	}
   36          } 
   37          
   38          PROC ReceiveSCMOutputMsg
   39          {
   40          	LOG CarFlag FOR ALL; 
   41          	FROM PROC Init S_CAR_NEAR_CROSSROAD;
   42          	INT SCMsgCode LOCAL;
   43          
   44          	STATE Start
   45          	{
   46          		IF (GetMessageFromScenariousBlock()) 
   47          		{
   48          			SCMsgCode = GetMessageCodeFromScenariousBlock();
   49          			SWITCH (SCMsgCode)
   50          			{
   51          				CASE SCM2VP_RUN_CAR:
   52          					IF(PROC RunCar SET STATE PASSIVE)
   53          					{
   54          						CarFlag = Norm;
   55          						START PROC RunCar;	
   56          					}
   57          					BREAK;					
   58          				CASE SCM2VP_RUN_WRONG_CAR:
   59          					IF(PROC RunCar SET STATE PASSIVE)
   60          					{
   61          						CarFlag = Wrong;
   62          						START PROC RunCar;	
   63          					}
   64          					BREAK;
   65          				CASE SCM2VP_RUN_TWO_CARS:
   66          					IF(PROC RunTwoCars SET STATE PASSIVE)
   67          					{
   68          						CarFlag = Norm;
   69          						START PROC RunTwoCars;	
   70          					}
   71          					BREAK;
   72          			}
   73          		}
   74          		LOOP;
   75          	}
   76          }
   77          
   78          PROC RunCar
   79          {
   80          	FROM PROC ReceiveSCMOutputMsg CarFlag;
   81          	FROM PROC Init S_CAR_NEAR_CROSSROAD, I_SWITCH_TRAFFIC_LIGHT;
   82          
   83          	STATE GetToSensor1 /*Доедем до датчика наличия машины и включим его*/
   84          	{
   85          		TIMEOUT DrivingTime 
   86          		{
   87          			S_CAR_NEAR_CROSSROAD = ON;
   88          			SET NEXT;
   89          		}
   90          	}
   91          	
   92          	STATE WaitingForSwitching /*Ждем пока светофор переключится на второстепенную дорогу*/
   93          	{ 
   94          		IF(I_SWITCH_TRAFFIC_LIGHT == ON)
   95          			SET NEXT;
   96          	}
   97          	
   98          	STATE WaitingYellowLight /*Ждем пока горит желтый сигнал*/
   99          	{
  100          		TIMEOUT YellowLightTime SET NEXT;
  101          	}
  102          	
  103          	STATE PassingSensor1 /*Ждем пока машина проедет датчик1*/
  104          	{
  105          		TIMEOUT SensorTime
  106          		{
  107          			
  108          			IF(CarFlag == Norm)
  109          			{
  110          				S_CAR_NEAR_CROSSROAD = OFF;
  111          			}
  112          			SET NEXT;
  113          		}
  114          	}
  115          	
  116          	STATE PassingCrossroad /*Ждем пока машина проедет перекресток*/
  117          	{
  118          		TIMEOUT CrossingTime
  119          		{
  120          			IF(CarFlag == Norm){
  121          				S_CAR_NEAR_CROSSROAD = ON;}
  122          			SET NEXT;
  123          		}
  124          	}
  125          	
  126          	STATE PassingSensor2 /*Ждем пока машина проедет датчик2*/
  127          	{
  128          		TIMEOUT SensorTime
  129          		{
  130          			IF(CarFlag == Norm){
  131          				S_CAR_NEAR_CROSSROAD = OFF;}
  132          			SET NEXT;
  133          		}
  134          	}
  135          	
  136          	STATE GetAwayFromSensor2 /*Ждем пока машина уедет от датчика*/
  137          	{
  138          		TIMEOUT DrivingTime STOP; 
  139          	}
  140          }
  141          
  142          PROC RunTwoCars
  143          {
  144          	FROM PROC Init S_CAR_NEAR_CROSSROAD, I_SWITCH_TRAFFIC_LIGHT;
  145          	INT car_number LOCAL;
  146          	
  147          	STATE Init
  148          	{
  149          		car_number = 1; /*1-ая машина*/	
  150          		SET NEXT;
  151          	}
  152          	
  153          	STATE GetToSensor1
  154          	{
  155          		TIMEOUT DrivingTime /*Доедем до датчика наличия машины и включим его*/
  156          		{
  157          			S_CAR_NEAR_CROSSROAD = ON;
  158          			SET NEXT;
  159          		}
  160          	}
  161          	
  162          	STATE WaitingForSwitching /*Ждем пока светофор переключится на второстепенную дорогу*/
  163          	{ 
  164          		IF(I_SWITCH_TRAFFIC_LIGHT == ON)
  165          			SET NEXT;
  166          	}
  167          	
  168          	STATE WaitingYellowLight /*Ждем пока горит желтый сигнал*/
  169          	{
  170          		IF(car_number == 2)
  171          			SET NEXT;
  172          		TIMEOUT YellowLightTime SET NEXT;
  173          	}
  174          	
  175          	STATE PassingSensor1 /*Ждем пока машина проедет датчик1*/
  176          	{
  177          		IF(I_SWITCH_TRAFFIC_LIGHT == OFF)
  178          			SET STATE WaitingForSwitching;
  179          		TIMEOUT SensorTime
  180          		{
  181          			S_CAR_NEAR_CROSSROAD = OFF;
  182          			SET NEXT;
  183          		}
  184          	}
  185          	
  186          	STATE PassingCrossroad /*Ждем пока машина проедет перекресток*/
  187          	{
  188          		TIMEOUT CrossingTime
  189          		{
  190          			S_CAR_NEAR_CROSSROAD = ON;
  191          			SET NEXT;
  192          		}
  193          	}
  194          	
  195          	STATE PassingSensor2 /*Ждем пока машина проедет датчик2*/
  196          	{
  197          		TIMEOUT SensorTime
  198          		{
  199          			S_CAR_NEAR_CROSSROAD = OFF;
  200          			SET NEXT;
  201          		}
  202          	}
  203          	
  204          	STATE GetAwayFromSensor2 /*Ждем пока машина уедет от датчика*/
  205          	{
  206          		TIMEOUT DrivingTime
  207          		{
  208          			IF(car_number == 1)
  209          			{
  210          				car_number++; /*2-ая машина*/
  211          				SET STATE GetToSensor1;
  212          			}
  213          			ELSE IF(car_number == 2)
  214          				STOP;
  215          		}
  216          	}
  217          }
  218          }

%RCSL-I-SUMMARY, Completed with 0 error(s).
%RCSL-I-SUMMARY, Completed with 0 warning(s).

 %RCSL-I-SUMMARY, Completed with 0 error(s).