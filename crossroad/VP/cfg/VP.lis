    1          PROGR PLANT
    2          {
    3          TACT 50;
    4          CONST ON 1;
    5          CONST OFF 0;
    6          CONST DrivingTime 10; /*~1 сек машина едет до датчика или от датчика после пересечения автострады*/
    7          CONST CrossingTime 10; /*~1 сек для пересечения автострады*/
    8          CONST YellowLightTime 20; /*~2 сек горит желтый свет светофора*/
    9          CONST SensorTime 10; /*~ сек машина проезжает датчик*/
   10          CONST Norm 1;
   11          CONST Wrong 0;
   12          
   13          ENUM
   14          {		
   15          	SCM2VP_RUN_CAR,
   16          	SCM2VP_RUN_WRONG_CAR,
   17          	SCM2VP_RUN_TWO_CARS
   18          };
   19          
   20          FUNCTION INT GetMessageFromScenariousBlock(VOID);
   21          FUNCTION INT GetMessageCodeFromScenariousBlock(VOID);
   22          	
   23          INPUT  LOG_VP_INPUT_PORT  0 0 8; 
   24          OUTPUT LOG_VP_OUTPUT_PORT 1 0 8;
   25          
   26          PROC Init
   27          {
   28          LOG I_SWITCH_TRAFFIC_LIGHT = {LOG_VP_INPUT_PORT[1]} FOR ALL;
   29          LOG S_CAR_NEAR_CROSSROAD = {LOG_VP_OUTPUT_PORT[1]} FOR ALL;
   30          	
   31          	STATE Start
   32          	{ 			
   33          		START PROC ReceiveSCMOutputMsg;
   34          		STOP;  
   35          	}
   36          } 
   37          
   38          PROC ReceiveSCMOutputMsg
   39          {
   40          	LOG CarFlag FOR ALL; 
   41          	FROM PROC Init S_CAR_NEAR_CROSSROAD;
   42          	INT SCMsgCode LOCAL;
   43          
   44          	STATE Start
   45          	{
   46          		IF (GetMessageFromScenariousBlock()) 
   47          		{
   48          			SCMsgCode = GetMessageCodeFromScenariousBlock();
   49          			SWITCH (SCMsgCode)
   50          			{
   51          				CASE SCM2VP_RUN_CAR:
   52          					IF(PROC RunCar SET STATE PASSIVE)
   53          					{
   54          						CarFlag = Norm;
   55          						START PROC RunCar;	
   56          					}
   57          					BREAK;					
   58          				CASE SCM2VP_RUN_WRONG_CAR:
   59          					IF(PROC RunCar SET STATE PASSIVE)
   60          					{
   61          						CarFlag = Wrong;
   62          						START PROC RunCar;	
   63          					}
   64          					BREAK;
   65          				CASE SCM2VP_RUN_TWO_CARS:
   66          					IF(PROC RunTwoCars SET STATE PASSIVE)
   67          					{
   68          						CarFlag = Norm;
   69          						START PROC RunTwoCars;	
   70          					}
   71          					BREAK;
   72          			}
   73          		}
   74          		LOOP;
   75          	}
   76          }
   77          
   78          PROC RunCar
   79          {
   80          	FROM PROC ReceiveSCMOutputMsg CarFlag;
   81          	FROM PROC Init S_CAR_NEAR_CROSSROAD, I_SWITCH_TRAFFIC_LIGHT;
   82          	
   83          	STATE Start
   84          	{
   85          		S_CAR_NEAR_CROSSROAD = OFF;
   86          		SET NEXT;
   87          	}
   88          
   89          	STATE GetToSensor1 /*Доедем до датчика наличия машины и включим его*/
   90          	{
   91          		TIMEOUT DrivingTime 
   92          		{
   93          			S_CAR_NEAR_CROSSROAD = ON;
   94          			SET NEXT;
   95          		}
   96          	}
   97          	
   98          	STATE WaitingForSwitching /*Ждем пока светофор переключится на второстепенную дорогу*/
   99          	{ 
  100          		IF(I_SWITCH_TRAFFIC_LIGHT == ON)
  101          			SET NEXT;
  102          	}
  103          	
  104          	STATE WaitingYellowLight /*Ждем пока горит желтый сигнал*/
  105          	{
  106          		TIMEOUT YellowLightTime SET NEXT;
  107          	}
  108          	
  109          	STATE PassingSensor1 /*Ждем пока машина проедет датчик1*/
  110          	{
  111          		TIMEOUT SensorTime
  112          		{
  113          			
  114          			IF(CarFlag == Norm)
  115          				S_CAR_NEAR_CROSSROAD = OFF;
  116          			SET NEXT;
  117          		}
  118          	}
  119          	
  120          	STATE PassingCrossroad /*Ждем пока машина проедет перекресток*/
  121          	{
  122          		TIMEOUT CrossingTime
  123          		{
  124          			IF(CarFlag == Norm)
  125          				S_CAR_NEAR_CROSSROAD = ON;
  126          			SET NEXT;
  127          		}
  128          	}
  129          	
  130          	STATE PassingSensor2 /*Ждем пока машина проедет датчик2*/
  131          	{
  132          		TIMEOUT SensorTime
  133          		{
  134          			IF(CarFlag == Norm || I_SWITCH_TRAFFIC_LIGHT == OFF)
  135          			{
  136          				S_CAR_NEAR_CROSSROAD = OFF;
  137          				SET NEXT;
  138          			}
  139          		}
  140          	}
  141          	
  142          	STATE GetAwayFromSensor2 /*Ждем пока машина уедет от датчика*/
  143          	{
  144          		TIMEOUT DrivingTime STOP;
  145          	}
  146          }
  147          
  148          PROC RunTwoCars
  149          {
  150          	FROM PROC Init S_CAR_NEAR_CROSSROAD, I_SWITCH_TRAFFIC_LIGHT;
  151          	INT car_number LOCAL;
  152          	
  153          	STATE Start
  154          	{
  155          		car_number = 1; /*1-ая машина*/	
  156          		SET NEXT;
  157          	}
  158          	
  159          	STATE GetToSensor1
  160          	{
  161          		TIMEOUT DrivingTime /*Доедем до датчика наличия машины и включим его*/
  162          		{
  163          			S_CAR_NEAR_CROSSROAD = ON;
  164          			SET NEXT;
  165          		}
  166          	}
  167          	
  168          	STATE WaitingForSwitching /*Ждем пока светофор переключится на второстепенную дорогу*/
  169          	{ 
  170          		IF(I_SWITCH_TRAFFIC_LIGHT == ON)
  171          			SET NEXT;
  172          	}
  173          	
  174          	STATE WaitingYellowLight /*Ждем пока горит желтый сигнал*/
  175          	{
  176          		IF(car_number == 2)
  177          			SET NEXT;
  178          		TIMEOUT YellowLightTime SET NEXT;
  179          	}
  180          	
  181          	STATE PassingSensor1 /*Ждем пока машина проедет датчик1*/
  182          	{
  183          		IF(I_SWITCH_TRAFFIC_LIGHT == OFF)
  184          			SET STATE WaitingForSwitching;
  185          		TIMEOUT SensorTime
  186          		{
  187          			S_CAR_NEAR_CROSSROAD = OFF;
  188          			SET NEXT;
  189          		}
  190          	}
  191          	
  192          	STATE PassingCrossroad /*Ждем пока машина проедет перекресток*/
  193          	{
  194          		TIMEOUT CrossingTime
  195          		{
  196          			S_CAR_NEAR_CROSSROAD = ON;
  197          			SET NEXT;
  198          		}
  199          	}
  200          	
  201          	STATE PassingSensor2 /*Ждем пока машина проедет датчик2*/
  202          	{
  203          		TIMEOUT SensorTime
  204          		{
  205          			S_CAR_NEAR_CROSSROAD = OFF;
  206          			SET NEXT;
  207          		}
  208          	}
  209          	
  210          	STATE GetAwayFromSensor2 /*Ждем пока машина уедет от датчика*/
  211          	{
  212          		TIMEOUT DrivingTime
  213          		{
  214          			IF(car_number == 1)
  215          			{
  216          				car_number++; /*2-ая машина*/
  217          				SET STATE GetToSensor1;
  218          			}
  219          			ELSE IF(car_number == 2)
  220          				STOP;
  221          		}
  222          	}
  223          }
  224          }

%RCSL-I-SUMMARY, Completed with 0 error(s).
%RCSL-I-SUMMARY, Completed with 0 warning(s).

 %RCSL-I-SUMMARY, Completed with 0 error(s).